name: Build MyOwn Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs: 
  build-godot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'npm'
          cache-dependency-path: 'angular/package-lock.json'

      # ==================== ANGULAR SETUP ====================
      - name: Install Angular dependencies
        working-directory: ./angular
        run: |
          npm ci 
          npm install @netlify/angular-runtime@latest
          echo "Angular + Netlify runtime installed!"

      # ==================== GODOT SETUP ====================
      - name: Install Godot
        run: |
          export GODOT_VERSION="3.6.2"
          echo "Downloading Godot ${GODOT_VERSION} Server version..."
          
          
          wget -q https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_mono_linux_server_64.zip
          unzip -q Godot_v${GODOT_VERSION}-stable_mono_linux_server_64.zip
          chmod +x Godot_v${GODOT_VERSION}-stable_mono_linux_server_64/Godot_v${GODOT_VERSION}-stable_mono_linux_server.64
          
          # Templates
          wget -q https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_mono_export_templates.tpz
          mkdir -p ~/.local/share/godot/templates/${GODOT_VERSION}.stable.mono
          unzip -q Godot_v${GODOT_VERSION}-stable_mono_export_templates.tpz
          cp -r templates/* ~/.local/share/godot/templates/${GODOT_VERSION}.stable.mono/
      
      # ==================== GODOT BUILD ====================
      - name: Build C# project
        run: |
          export GODOT_VERSION="3.6.2"
          echo "Building C# project..."
          ./Godot_v${GODOT_VERSION}-stable_mono_linux_server_64/Godot_v${GODOT_VERSION}-stable_mono_linux_server.64 \
            --path godot \
            --build-solutions \
            --quit
          echo "C# project built."

      # ==================== GODOT EXPORT ====================
      - name: Export to Web
        run: |         
          export GODOT_VERSION="3.6.2"
          echo "Exporting Godot directly to Angular assets..."

          mkdir -p angular-cv/src/assets/godot-game

          ./Godot_v${GODOT_VERSION}-stable_mono_linux_server_64/Godot_v${GODOT_VERSION}-stable_mono_linux_server.64 \
          --path godot \
          --export "HTML5" \
          angular-cv/src/assets/godot-game/MyOwn.html \
          --quit
          
          echo "Godot exported directly to Angular!"
          echo "Generated files in Angular:"
             
      - name: Build Angular Application
        working-directory: ./angular
        run: |
          echo "Building Angular application..."
          npm run build
          echo "Angular application built."

      # ==================== NETLIFY DEPLOY ====================
      - name: Deploy to Netlify
        run: |
          cd angular
          npm run build

      - name: Netlify Deploy
        run: |
          npm install -g netlify-cli
          cd angular/dist/angular/browser
          netlify deploy --prod --dir=. --message="Deploy with runtime"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        if: github.ref == 'refs/heads/main'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: angular
          path: angular/dist/
          retention-days: 7